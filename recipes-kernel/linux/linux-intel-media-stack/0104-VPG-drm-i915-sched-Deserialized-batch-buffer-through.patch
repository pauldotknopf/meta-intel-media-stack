From 1d78debc0a33d8bf325b4a8f43cfac941cc199b8 Mon Sep 17 00:00:00 2001
From: Zhipeng Gong <zhipeng.gong@intel.com>
Date: Sat, 19 Mar 2016 10:19:46 -0400
Subject: [PATCH 104/153] [VPG]: drm/i915/sched: Deserialized batch buffer through user id.

---
 drivers/gpu/drm/i915/i915_dma.c            |    3 +++
 drivers/gpu/drm/i915/i915_drv.h            |    1 +
 drivers/gpu/drm/i915/i915_gem_execbuffer.c |    5 +++--
 drivers/gpu/drm/i915/i915_scheduler.c      |    3 +++
 include/uapi/drm/i915_drm.h                |    1 +
 5 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/i915/i915_dma.c b/drivers/gpu/drm/i915/i915_dma.c
index 0979a27..61f485f 100644
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@ -178,6 +178,9 @@ static int i915_getparam(struct drm_device *dev, void *data,
 		value = !dev_priv->workarounds.WaForceEnableNonCoherent &&
 			INTEL_INFO(dev)->gen >= 9;
 		break;
+	case I915_PRIVATE_PARAM_SCHEDULER_SUPPORT_USER_CTX:
+		value = 1;
+		break;
 	default:
 		DRM_DEBUG("Unknown parameter %d\n", param->param);
 		return -EINVAL;
diff --git a/drivers/gpu/drm/i915/i915_drv.h b/drivers/gpu/drm/i915/i915_drv.h
index b396858..2ead172 100644
--- a/drivers/gpu/drm/i915/i915_drv.h
+++ b/drivers/gpu/drm/i915/i915_drv.h
@@ -1757,6 +1757,7 @@ struct i915_execbuffer_params {
 	int                             instp_mode;
 	struct intel_context            *ctx;
 	struct drm_i915_gem_request     *request;
+	uint32_t                        user_ctx_id;
 };
 
 struct i915_scheduler;
diff --git a/drivers/gpu/drm/i915/i915_gem_execbuffer.c b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
index 5dce979..186f55e 100644
--- a/drivers/gpu/drm/i915/i915_gem_execbuffer.c
+++ b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
@@ -966,8 +966,8 @@ i915_gem_check_execbuffer(struct drm_i915_gem_execbuffer2 *exec)
 		return false;
 
 	/* Kernel clipping was a DRI1 misfeature */
-	if (exec->num_cliprects || exec->cliprects_ptr)
-		return false;
+	if (exec->cliprects_ptr)
+			return false;
 
 	if (exec->DR4 == 0xffffffff) {
 		DRM_DEBUG("UXA submitting garbage DR4, fixing up\n");
@@ -1744,6 +1744,7 @@ i915_gem_do_execbuffer(struct drm_device *dev, void *data,
 	params->args_flags              = args->flags;
 	params->args_batch_len          = args->batch_len;
 	params->args_num_cliprects      = args->num_cliprects;
+	params->user_ctx_id             = args->num_cliprects;
 	params->args_DR1                = args->DR1;
 	params->args_DR4                = args->DR4;
 	params->batch_obj               = batch_obj;
diff --git a/drivers/gpu/drm/i915/i915_scheduler.c b/drivers/gpu/drm/i915/i915_scheduler.c
index 75260bd..4645ce7 100644
--- a/drivers/gpu/drm/i915/i915_scheduler.c
+++ b/drivers/gpu/drm/i915/i915_scheduler.c
@@ -776,6 +776,9 @@ static int i915_generate_dependencies(struct i915_scheduler *scheduler,
 		if (that->ring != node->params.ring)
 			continue;
 
+		if (that->scheduler_qe->params.user_ctx_id != node->params.user_ctx_id)
+			continue;
+
 		if (that->dep_uniq != req->uniq) {
 			node->dep_list[node->num_deps] = that->scheduler_qe;
 			node->num_deps++;
diff --git a/include/uapi/drm/i915_drm.h b/include/uapi/drm/i915_drm.h
index 208d18f..b1fb241 100644
--- a/include/uapi/drm/i915_drm.h
+++ b/include/uapi/drm/i915_drm.h
@@ -362,6 +362,7 @@ typedef struct drm_i915_irq_wait {
 #define I915_PARAM_HAS_RESOURCE_STREAMER 36
 #define I915_PARAM_HAS_EXEC_SOFTPIN	 37
 
+#define I915_PRIVATE_PARAM_SCHEDULER_SUPPORT_USER_CTX  (-2)
 #define I915_PRIVATE_PARAM_HAS_EXEC_FORCE_NON_COHERENT (-1)
 
 typedef struct drm_i915_getparam {
-- 
1.7.1

